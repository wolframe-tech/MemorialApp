
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editar √Årbol</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    .preview-img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .delete-btn {
      display: inline-block;
      margin-left: -20px;
      margin-right: 10px;
      cursor: pointer;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Editar √Årbol</h2>
  <form id="editarForm">
    <label>Nombre: <input type="text" id="nombre" /></label><br><br>
    <label>Modelo 3D:
      <select id="modelo"></select>
    </label>
    <model-viewer id="previewModel" style="width:100%; height:300px;" alt="Vista previa 3D" auto-rotate camera-controls background-color="#EEE"></model-viewer>
    <br>
    <label>Fecha de nacimiento: <input type="date" id="nacimiento" /></label><br><br>
    <label>Fecha de fallecimiento: <input type="date" id="fallecimiento" /></label><br><br>
    <label>Canci√≥n conmemorativa (YouTube): <input type="text" id="cancion" /></label>
    <div id="youtubePreview" style="margin-top:10px;"></div>
    <br>
    <label>Agregar nuevas im√°genes: <input type="file" id="nuevasImagenes" accept="image/*" multiple /></label><br>
    <div id="imagenesActuales"></div>
    <br><br>
    <button type="submit">Guardar Cambios</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, deleteObject, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCU8P2Fd34ymLWBYWDlQfZuImyJh0gmASA",
      authDomain: "memorialapp-b1ccf.firebaseapp.com",
      projectId: "memorialapp-b1ccf",
      storageBucket: "memorialapp-b1ccf.appspot.com",
      messagingSenderId: "931250217735",
      appId: "1:931250217735:web:a010fff296af35e6a41ba2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    const storage = getStorage(app);

    const modelos = [
      { nombre: "√Årbol estilo Anime", archivo: "jabami_anime_tree_v2.glb" },
      { nombre: "√Årbol con flores p√∫rpura", archivo: "low_poly_purple_flowers.glb" },
      { nombre: "Bons√°i Ficus", archivo: "ficus_bonsai.glb" },
      { nombre: "Maceta", archivo: "flowerpot.glb" },
      { nombre: "Olmo", archivo: "tree_elm.glb" }
    ];

    const arbolId = new URLSearchParams(window.location.search).get("id");
    let uidActual = "";

    function transformarURLYoutube(url) {
      const videoId = url.split("v=")[1]?.split("&")[0] || url.split("/").pop();
      return `https://www.youtube.com/embed/${videoId}`;
    }

    async function cargarDatos(uid) {
      const docRef = doc(db, "arboles", arbolId);
      const snap = await getDoc(docRef);
      if (!snap.exists()) return alert("√Årbol no encontrado");

      const data = snap.data();
      if (data.uid !== uid) return alert("No autorizado");

      document.getElementById("nombre").value = data.nombre || "";
      document.getElementById("nacimiento").value = data.nacimiento || "";
      document.getElementById("fallecimiento").value = data.fallecimiento || "";
      document.getElementById("cancion").value = data.cancion || "";

      const modeloSelect = document.getElementById("modelo");
      modelos.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.archivo;
        opt.textContent = m.nombre;
        if (data.modelo === m.archivo) opt.selected = true;
        modeloSelect.appendChild(opt);
      });

      const preview = document.getElementById("previewModel");
      preview.src = `https://firebasestorage.googleapis.com/v0/b/memorialapp-b1ccf.appspot.com/o/modelos_3d%2F${encodeURIComponent(data.modelo)}?alt=media`;

      modeloSelect.addEventListener("change", e => {
        preview.src = `https://firebasestorage.googleapis.com/v0/b/memorialapp-b1ccf.appspot.com/o/modelos_3d%2F${encodeURIComponent(e.target.value)}?alt=media`;
      });

      document.getElementById("youtubePreview").innerHTML = `<iframe width="300" height="200" src="${transformarURLYoutube(data.cancion)}" frameborder="0" allowfullscreen></iframe>`;

      const contenedor = document.getElementById("imagenesActuales");
      if (data.imagenes?.length) {
        for (const url of data.imagenes) {
          const img = document.createElement("img");
          img.src = url;
          img.className = "preview-img";

          const btn = document.createElement("span");
          btn.innerHTML = "üóëÔ∏è";
          btn.className = "delete-btn";
          btn.onclick = async () => {
            if (!confirm("¬øEliminar esta imagen?")) return;
            try {
              const path = decodeURIComponent(url.split("/o/")[1].split("?alt=")[0]);
              await deleteObject(ref(storage, path));
              await updateDoc(docRef, { imagenes: arrayRemove(url) });
              img.remove();
              btn.remove();
            } catch (e) {
              alert("‚ùå No se pudo eliminar");
            }
          };

          contenedor.appendChild(btn);
          contenedor.appendChild(img);
        }
      }
    }

    onAuthStateChanged(auth, user => {
      if (!user) return alert("No autenticado");
      uidActual = user.uid;
      cargarDatos(uidActual);
    });

    document.getElementById("editarForm").addEventListener("submit", async e => {
      e.preventDefault();

      const nombre = document.getElementById("nombre").value.trim();
      const nacimiento = document.getElementById("nacimiento").value;
      const fallecimiento = document.getElementById("fallecimiento").value;
      const cancion = document.getElementById("cancion").value.trim();
      const modelo = document.getElementById("modelo").value;
      const nuevas = document.getElementById("nuevasImagenes").files;

      const urlsNuevas = [];
      for (const file of nuevas) {
        const ruta = `arboles/${uidActual}/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, ruta);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        urlsNuevas.push(url);
      }

      const arbolRef = doc(db, "arboles", arbolId);
      await updateDoc(arbolRef, {
        nombre, nacimiento, fallecimiento, cancion, modelo,
        imagenes: arrayUnion(...urlsNuevas)
      });

      alert("‚úÖ Cambios guardados");
      location.reload();
    });
  </script>
</body>
</html>
