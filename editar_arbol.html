
<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Editar √Årbol</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js" type="module"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js" type="module"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js" type="module"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js" type="module"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js" type="module"></script>
<script src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js" type="module"></script>
<style>
    body { font-family: sans-serif; padding: 1rem; }
    model-viewer { width: 100%; height: 300px; background: #eee; }
    .imagen-container { display: inline-block; position: relative; margin: 5px; }
    .imagen-container img { width: 100px; height: 100px; object-fit: cover; }
    .imagen-container button { position: absolute; top: 2px; right: 2px; background: red; color: white; border: none; border-radius: 50%; cursor: pointer; }
  </style>
</head>
<body>
<h2>Editar √Årbol</h2>
<form id="formEditar">
<label>Nombre:<br/><input id="nombre" required="" type="text"/></label><br/><br/>
<label>Modelo 3D:<br/>
<select id="modelo3D"></select>
</label><br/><br/>
<model-viewer auto-rotate="" camera-controls="" id="preview3D"></model-viewer><br/><br/>
<label>Fecha de nacimiento:<br/><input id="nacimiento" type="date"/></label><br/><br/>
<label>Fecha de fallecimiento:<br/><input id="fallecimiento" type="date"/></label><br/><br/>
<label>Canci√≥n conmemorativa (YouTube):<br/><input id="cancion" type="text"/></label><br/><br/>
<div id="videoPreview"></div><br/>
<div>
<label>Im√°genes actuales:</label>
<div id="imagenesActuales"></div>
</div><br/>
<label>Agregar nuevas im√°genes:<br/><input accept="image/*" id="imagenesNuevas" multiple="" type="file"/></label><br/><br/>
<button type="submit">Guardar Cambios</button>
</form>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCU8P2Fd34ymLWBYWDlQfZuImyJh0gmASA",
      authDomain: "memorialapp-b1ccf.firebaseapp.com",
      projectId: "memorialapp-b1ccf",
      storageBucket: "memorialapp-b1ccf.appspot.com",
      messagingSenderId: "931250217735",
      appId: "1:931250217735:web:a010fff296af35e6a41ba2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const urlParams = new URLSearchParams(window.location.search);
    const arbolId = urlParams.get("id");
    let arbolData = null;

    const modeloSelect = document.getElementById("modelo3D");
    const preview3D = document.getElementById("preview3D");
    const videoPreview = document.getElementById("videoPreview");
    const imagenesActuales = document.getElementById("imagenesActuales");

    const modelos = [
      { nombre: "√Årbol estilo Anime", archivo: "jabami_anime_tree_v2.glb" },
      { nombre: "√Årbol con flores p√∫rpura", archivo: "low_poly_purple_flowers.glb" },
      { nombre: "Bons√°i", archivo: "ficus_bonsai.glb" },
      { nombre: "Maceta 1", archivo: "flowerpot.glb" },
      { nombre: "√Årbol grande", archivo: "tree_elm.glb" }
    ];

    modelos.forEach(modelo => {
      const option = document.createElement("option");
      option.value = modelo.archivo;
      option.textContent = modelo.nombre;
      modeloSelect.appendChild(option);
    });

    modeloSelect.addEventListener("change", () => {
      const modelUrl = `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/modelos_3d%2F${modeloSelect.value}?alt=media`;
      preview3D.src = modelUrl;
    });

    function embedYoutube(url) {
      const videoId = url.split("v=")[1]?.split("&")[0] || url.split("/").pop();
      return `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
    }

    function renderImagenes(imagenes) {
      imagenesActuales.innerHTML = "";
      imagenes.forEach(url => {
        const div = document.createElement("div");
        div.className = "imagen-container";

        const img = document.createElement("img");
        img.src = url;
        img.alt = "Imagen conmemorativa";

        const btn = document.createElement("button");
        btn.textContent = "üóëÔ∏è";
        btn.onclick = async () => {
          if (confirm("¬øSeguro que deseas eliminar esta imagen?")) {
            try {
              const path = decodeURIComponent(new URL(url).pathname.split("/o/")[1].split("?")[0]);
              await deleteObject(ref(storage, path));
              await updateDoc(doc(db, "arboles", arbolId), {
                imagenes: arrayRemove(url)
              });
              renderImagenes(arbolData.imagenes.filter(img => img !== url));
              alert("Imagen eliminada");
            } catch (err) {
              alert("‚ùå Error al eliminar imagen: " + err.message);
            }
          }
        };

        div.appendChild(img);
        div.appendChild(btn);
        imagenesActuales.appendChild(div);
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (user && arbolId) {
        const docRef = doc(db, "arboles", arbolId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          arbolData = docSnap.data();
          document.getElementById("nombre").value = arbolData.nombre;
          modeloSelect.value = arbolData.modelo;
          preview3D.src = `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/modelos_3d%2F${arbolData.modelo}?alt=media`;
          document.getElementById("nacimiento").value = arbolData.nacimiento;
          document.getElementById("fallecimiento").value = arbolData.fallecimiento;
          document.getElementById("cancion").value = arbolData.cancion;
          videoPreview.innerHTML = embedYoutube(arbolData.cancion);
          renderImagenes(arbolData.imagenes || []);
        }
      }
    });

    document.getElementById("formEditar").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nombre = document.getElementById("nombre").value;
      const modelo = modeloSelect.value;
      const nacimiento = document.getElementById("nacimiento").value;
      const fallecimiento = document.getElementById("fallecimiento").value;
      const cancion = document.getElementById("cancion").value;
      const nuevas = document.getElementById("imagenesNuevas").files;

      const nuevasURLs = [];

      for (let file of nuevas) {
        const storageRef = ref(storage, `arboles/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
        const snap = await uploadBytes(storageRef, file);
        const url = await getDownloadURL(snap.ref);
        nuevasURLs.push(url);
      }

      await updateDoc(doc(db, "arboles", arbolId), {
        nombre, modelo, nacimiento, fallecimiento, cancion,
        imagenes: arrayUnion(...nuevasURLs)
      });

      alert("‚úÖ Cambios guardados");
      window.location.href = "galeria.html";
    });
  </script>
</body>
</html>
